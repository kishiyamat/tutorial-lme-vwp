---
layout: post
title: Rと統計の入門
description: <a href="./">  🏠  </a><br>
    <a href="./">⏪</a> 最短で乗り切ります。 <a href="./2.html">⏩</a>
---

<!--
1. モデルとは?
1. 最終的に理解したい要素
1. 出てくるもののみに候補
-->

このチュートリアルのゴールは「一般化線形混合モデルを用いた統計分析」の理解です。
そのためには「モデル」や「統計」の理解が必要であるため、
導入として以下に
<u>(i) モデルが必要な理由(+そもそもモデルとは何か)</u> と
<u>(ii) 最終的に理解したい対象</u> を考え、
<u>(iii) 過程で必要な概念</u> を整理していきます。

なお、このチュートリアルのコンセプトは「手を動かしながら理解する」なので、
下のような作業場を使っていきます[^code]。
アドブロックをオンにしてるとセッションが壊れる場合があるので
本サイトではオフにしてください[^adblock]。

[^code]: 以前はゼミの勉強会などでは
    RとRStudioをインストールして、
    パッケージをインストールして、
    あぁバージョンが合わない、
    そもそも文字化けする、という悲しみがあったのですが、
    最近はウェブで実行できます。

[^adblock]: 検証してくれたOさんに感謝します。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
  </code>
  <code data-type="sample-code">
    # print 関数を使って
    # "Hello LME!" と出力してみてください
    # print("Hello LME!")
  </code>
  <code data-type="solution">
    print("Hello LME!")
  </code>
  <code data-type="sct">
    test_function("print")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  Use the print function to say "Hello LME!"
  </div>
</div>

<!--
これは手を動かして見たほうが分かりやすかったりします。
でもそもそも「モデル」ってなんなんでしょうか。
まずはそこから考えてみましょう。
-->

## モデル: 現象を理解するためのツール

以下、「モデルが必要な理由」を考えていきます。

<!--嬉しい理由-->
まず現象の理解が目的の研究を想定します。
例えば「主語述語の距離と認知的負荷の関係を知りたい」や
「主語と述語の不一致が認知的負荷を生むんじゃなかろうか」などです。
ここで認知的負荷を「単語の読み時間」で観測できるなら、
(1a) 要因(主語述語の距離など)の貢献度合い と (1b) 貢献度の確からしさ
を知ることが現象の理解につながります。

上は偏った例ですが、同様に手持ちの課題を観測できる値に落とし込めたとします[^wh]。
画面の注視時間でもアンケートの値でもなんでもOKで、
その観測と要因の関係を上の(1a)と(1b)で調べてあげたいわけです。
<!--
さて、その観測に影響する候補の要因が2つあるとして、
観測を$y$, 要因1を$x_1$, 要因2を$x_2$ としてあげましょう。
-->
そこで$y$は単語の読み時間(s)、$x_1$ は主語--述語間の単語数、
$x_2$ は主語--述部の一致(0/1) をそれぞれ表現しているとします。
ただ「単語数+1」としても$y$にはならないことから、
そのまま $y = x_1 + x_2$ とはならなさそうです。

[^wh]: この直接観測できない対象を観測できる値で代用する作業を
    「Linking Hypothesis を置く」なんて言ったりします。

<!--
ちなみに $\uparrow$ のように斜体を使うとき、
「中身の値は変わるかもよ」という意味を込めています。
なので変数とか言ったりしますが、-->
<!-- (そもそも $x_1$ と $x_2$ が両方読み時間を増やすとは限りません) -->

そこで$y$と各要因$x_1, x_2$の関係を調整してくれる $a_1$ や $a_2$ も考えてあげます。
例えば、$x_1$ が読み時間に影響しない場合は $a_1 = 0$ 、
大きく効果がある場合は大きな値、減少させる場合は負の値になります。 <!--
掛け算を変数をくっつけて書くことで表現すると、
--> するとさっきの式は $y = a_1x_1 + a_2x_2 + b$ と書いたほうが良さそうで、
このような式のことを「線形モデル」と呼びます。
(なお傾き$a$や切片$b$は未知ですが $y$ や $x$ は既知です。)

ここでもう一度 $y = a_1x_1 + a_2x_2 + b$ の式を見ると、
先ほどの問に答えられそうなことがわかります。
つまり (1a) 要因(主語述語の距離など)の貢献度合い を比較すれば
読み時間を説明する要因の中での優劣がわかり、
さらに (1b) 貢献度の確からしさ
がわかれば要因の効果の確からしさになります。
したがって、<u>研究の目的が現象の理解である場合、
その目的は観測と要因を結ぶモデルの作成で達成できます</u>。

以上がモデルと統計(確からしさ)を学ぶ意義になります。

## 一般化とノイズ

次に「最終的に理解したい対象」を考えますが、
結論を言えば
(2a) 直線以外の関係 と
(2b) 構造的なノイズ
を扱えるモデルです。
先ほどの例では読み時間を $y = a_1x_1 + a_2x_2 + b$ と表現しました。
この表現は「線形モデル」と呼ばれるもので、
読み時間が要因に対して直線の関係にあることや負の値を取れることを仮定してます。

まず(2a)に関してですが、
上のように読み時間が負の値を取ることはありません。
他にもアンケート(0--5など)、文の容認性(0--1)、OTのランキング(0--N)などで
マイナスの値を含めた範囲外の値を取れてしまいます。
そこで $y = a_1x_1 + a_2x_2 + b$ のような直線のモデルを
直線以外も扱えるよう一般化したのが「<u>一般化</u>線形モデル」です。
このチュートリアルの中間地点になります。

次に(2b)に関しては読み時間の個人差を考えましょう。
読み時間では要因に反応しやすい人、しづらい人がいます。
この個人差のような、
何かに条件付けられた構造的なノイズを「ランダム効果」として
切り捨てることで、本当に見たい効果が見れます。
先ほどの「一般化線形モデル」で更にこのランダム効果を考慮できるのが
「一般化線形<u>混合</u>モデル」です。
このチュートリアルの最終到達目標になります。

冒頭でこのチュートリアルのゴールは
一般化線形混合モデルを用いた統計分析の理解だと述べました。
この「一般化線形混合モデルを用いた統計分析」の意味はもう分かると思います。
つまり、$y = a_1x_1 + a_2x_2 + b$ のような線形モデルを

(2a) 直線以外の関係 に一般化させ  
(2b) 構造的なノイズ を考慮したモデルを作り、  
(1a) 要因の貢献度合い と  
(1b) 貢献度合いの確からしさ(統計)

を検証するのです。
そうすれば様々な現象の理解を構造的なノイズを排除して理解でき、
研究の目的を達成する一助となります。

次に実際に手を動かしながら
最初のステップである
(1) 線形モデルの作成と
(2) 統計分析
を進めて行きましょう。
その過程で必要な概念を整理していきます。

## モデルの基本要素

次に統計モデルとその基本要素である
(i) `data.frame`
(ii) `formula`
(iii) `model`
の概念を抑えていきます。
以下、先ほどの例でで出てきた
$y = a_1x_1 + a_2x_2 + b$ のような「線形モデル」
を例に考えます。

### data.frame

まず簡単な例として `sleepstudy` というデータを見てみましょう。
データの概要は睡眠不足(寝不足何日目か, `Days`)と反応時間(`Reaction`)の関係を
被験者ごと(`Subject`)に見た、
というものです。
いかにも「`Days`が上がれば`Reaction`も増えそうだな」
というのがわかります。

> The average reaction time per day for subjects in a sleep deprivation study. On day 0 the subjects had their normal amount of sleep. Starting that night they were restricted to 3 hours of sleep per night. The observations represent the average reaction time on a series of tests given each day to each subject. 

なお「データを見る」といったときの「データ」は
`data.frame` という概念を意味しているんだな、
と以降は読み替えてください。
この `data.frame` というのは Excel を思い浮かべると分かりやすく、
一行目は列名で二行目からは各列のデータを持ちますよね。
それを R ではデータフレーム (`data.frame`) と呼びます。

もちろん `data.frame` の全てを表示することもできるのですが、
Rには`()`を右に持つ「関数」というのがあり、例として `head()` があります。
この `head()` は `data.frame` を `()` の中に受け取ると
最初の6件をデフォルトで返します。
以下に `sleepstudy` という `data.frame` を既に読み込んであるので、
`sleepstudy` を `head()` の `()` に入れて動作を確認してみましょう。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
    # lme4パッケージは読み込み済み
    library(lme4)
  </code>
  <code data-type="sample-code">
    # sleepstudy というデータが手元にある状態
    # head() の () に sleepstudy と入力して Submit
    head()
  </code>
  <code data-type="solution">
    head(sleepstudy)
  </code>
  <code data-type="sct">
    test_function("head")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  Use head and summary to see the data.
  </div>
</div>

`sleepstudy` の最初の6行を確認できたでしょうか。
1行目の`Reaction` は`249.5600`(ms)、
`Days` は`0`, `Subject`(被験者番号)は`308`
となっているので、
寝不足0日目の308番さんの反応時間は249msだったことがわかります。

ここまでをまとめると,

1. Rは `data.frame` の形でデータを扱う (例: `sleepstudy`)。
1. `data.frame` を受け取る関数がある (例: `head()`)。
1. `data.frame` には列と値がある (例:`Reaction`と`249.5600` )。

ということがわかります[^all]。

[^all]: どうしても実体が気になるひとは R Console の方に
    `sleepstudy` とだけ打ち込んでみてください。
    データを全件表示してくれますが、
    これはデータが少ないことを知っている時以外は行わないでください。

### formula

次は `formula` という概念です。
先程は $y = a_1x_1 + a_2x_2 + b$ という式を見ましたが、
これを `sleepstudy` に当てはめるとどうなるでしょうか。
(`Subject` はいわゆる「構造的なノイズ」なので
今は無視します)

`Reaction` を `Days`(寝不足何日目か) で説明すると、
$Reaction = aDays + b$ という式になりますね。
ここで (1a) 要因(`Days`)の効果の強さ と  (1b) 要因の確からしさ
を$a$で見てあげると、反応時間とDaysの関係が分かりそうです
($a$ が「統計的に(後で説明します)」0じゃないなら効果あり)。

Rでは $Reaction = aDays + b$ という式を
`Reaction ~ Days` のように `~` で表現でき、これを `formula` と呼びます。
ここで `Reaction` や `Days` という文字列は
`data.frame` の列名と一致していなければなりません。
なので `Reaction ~ a*Days + b` としても
(Rは掛け算を`*`で表現します)
`a`や`b`は未知なので後々エラーになります。

この `formula` はデータを与えた時、
データ内の列の関係を記述するのに役立ちます。
そうすると、「モデル」を作るときや
グラフの描画が非常に楽になります。ここではグラフの描画を見てみましょう。
描画には後々 `ggplot` というリッチなツールを使う事にもなるでしょうが、
今は分かりやすい `xyplot` という関数を使います。
`xyplot` は `formula` と `data` を受け取って描画します。
カンマで区切って`formula`と`sleepstudy`渡してあげましょう。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
    library(lattice)  # for xyplot
    library(lme4)  # for sleapstudy data
  </code>
  <code data-type="sample-code">
    # 1. Reaction と Days の関係を ~ で記述し
    #    一旦 f に格納 f = `Your Answer`
    f = 

    # 2. xyplot に f と sleepstudy を渡して Submit
    xyplot(, ) # edit here
  </code>
  <code data-type="solution">
    f = Reaction ~ Days
    xyplot(f, sleepstudy)
  </code>
  <code data-type="sct">
    test_function("xyplot")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  </div>
</div>

ちゃんと右肩あがりの図が描画されたでしょうか。
説明が分かりづらかった場合はHintを押して答え(Solution)を確認した後、
もう一度実行してみてください。

ここまでをまとめると,

1. R の `formula` は `~` で `data.frame` 内の列同士の関係を記述できる
   (例: `Reaction ~ Days`)
1. `formula` はグラフの作成やモデルの作成に使える(例: `xyplot`)
1. `formula` 内の記述は `data.frame` 内のものでないとならない
   (例: `sleepstudy` の記述に `Days` は使えるが `days` や `a` は使えない)

ということがわかります[^group]。

[^group]: 余裕がある人は上で `f = Reaction ~ Days | Subject` とすると
    どうなるかを確認してください。
    この `|` は条件付けで、`Subject` ごとの `Days` と `Reaction` の関係
    を示すことになります。Plotsを押すと画像が開かれます。

### model

最後に `model` について話して「線形モデル」は終わりです。
上の `formula` で $Reaction = aDays + b$ を
`Reaction ~ Days` と表現でき、
`Reaction ~ a*Days + b` としても `a`や`b`は未知なのでエラーになると述べました。
ただ我々が知りたいのは `a` の大きさや確からしさで、
`a` や `b` の推定こそが `model` の役割です。

実際には `model(formula, data.frame)` と入力することで
未知の傾き`a`や切片`b`を`model`が推定してくれます。
言い方を変えると、`Reaction ~ Days` には `a` や `b` が隠れていて、
それらを調整して上手いこと `Reaction ~ a*Days + b` が成り立つような
傾き`a`や切片`b` を `model` が推定してくれます。

そして `model` には色々な種類があり
線形モデルの `lm`, 一般化線形モデルの `glm`、
そして一般化線形混合モデルの `lmer` と抽象化されていきます。
ここでは一度、線形モデル`lm`を使って挙動を確認してみましょう。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
    library(lme4)  # for sleapstudy data
  </code>
  <code data-type="sample-code">
    # 1. Reaction と Days の関係を ~ で記述し
    #    一旦 f に格納 f = `Your Answer`
    f = 
    # 2. lm に f と sleepstudy を渡して Submit
    lm(, ) # edit here
  </code>
  <code data-type="solution">
    f = Reaction ~ Days
    lm(f, sleepstudy)
  </code>
  <code data-type="sct">
    test_function("lm")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  </div>
</div>

走らせた結果、
以下のように `Coefficients`(係数)が
`Intercept`(切片)は `251.41`、 `Days`(傾き)は `10.47`になる
と表示されたでしょうか。先ほど、こんなことを言ったのですが、

> 言い方を変えると、`Reaction ~ Days` には `a` や `b` が隠れていて、
> それらを調整して上手いこと `Reaction ~ a*Days + b` が成り立つような
> 傾き`a`や切片`b` を `model` が推定してくれます。

つまり傾き`a`が`10.47`、切片`b`が`251.41`の時に、
 `Reaction ~ a*Days + b` が上手いこと成り立つという事になります。
つまり基本の反応時間は`251.41`ミリセカンド(つまり0.2秒ほど)で、
寝不足が1日増えるごとに`10.47`ミリセカンドずつ反応が悪くなる
($Reaction = 10.47 \cdot Days + 251.41$)、
という話になります。

さて、もちろん分野にもよるのですが、
ここで「その差って統計的に信頼できるの？」という疑問が出てきます。
そこで最後に `summary()` という関数に
上の `model` を渡してあげましょう。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
    library(lme4)  # for sleapstudy data
  </code>
  <code data-type="sample-code">
    # 1. Reaction と Days の関係を ~ で記述し
    #    一旦 f に格納 f = `Your Answer`
    f = 
    # 2. lm に f と sleepstudy を渡して Submit
    m = lm(, )
    # 3. m を summary に渡す
    summary()
  </code>
  <code data-type="solution">
    f = Reaction ~ Days
    m = lm(f, sleepstudy)
    summary(m)
  </code>
  <code data-type="sct">
    test_function("summary")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  </div>
</div>

たくさんの情報が出てきたと思いますが、
大切なのは各要因($Days$) と同じ行にある `Pr(>|t|)` の値です。
分野にもよりますが、これが 0.05 より小さければ
「その傾きは統計的に意味のあるものなんだよ」と安全に主張できます。
なお `9.89e-15` は 9.89の`.`を左に15ずらしたものです(0.000...)。

ここまでをまとめると,

1. R の `model` は `formula` と `data.frame` を取って未知の値を推定してくれる
   (例: 要因に対する傾き`a`や切片`b`)
1. `model`が求めた「要因に対する傾きや切片」を見れば要因と現象の関係がわかる[^fit]
   (例: $Reaction = 10.47 \cdot Days + 251.41$)
1. 傾きの確からしさは `summary()` 関数で分かる
   (例: `Days` の `Pr(>|t|)` は `9.89e-15`)

ということがわかります。
傾きの値や確からしさの求め方が気になる方は
それぞれ [データ解析のための統計モデリング入門][green] の 
p.24 と p.51 に関連する記述があります。

[green]: https://www.iwanami.co.jp/book/b257893.html

## まとめ

<!--
ここまで
(i) モデルが必要な理由(why) と
(ii) 最終的に理解したい対象(what) を考え、
(iii) 過程で必要な概念(how)を整理していきました。-->

結局、私達が分析時にすることは以下になります。
モデルを作ることで現象の理解と主張を補助できて、
実際のモデルを作成/分析する過程は

1. `data.frame` を用意する。(例:調査や実験で
   説明されるもの(`Reaction`)と説明するもの(`Days`)を集めて整形する。)
2. `data` の関係を`formula` を定義して表現 (例: `Reaction ~ Days`)
3. `model` に `formula` と `data` 与えて未知のパラメータを推定、解釈

となります。
つまり「モデルを作る」というのは
データを用意して、データの関係を定義し、
モデルのパラメータを推定させることなのです。

今回扱った `lm` は線形モデルでした。
ただ、
「`Reaction` じゃなくて `ErrorRate` みたいな 0--1 の値は
直線でモデルできないじゃないか」や
「`Reaction`に対する`Days`の効果や、
そもそも `Reaction` のベースの時間って人によるじゃないか」
といったツッコミもありえます。
それぞれの問に対応できるのが
(2a) 直線以外の関係 や (2b) 構造的なノイズ を扱ったモデルでした。
そこで [次のユニット][u2] は(2a)に対応する<u>一般化</u>線形モデル、
[最後のユニット][u3] では(2b)に対応する一般化線形<u>混合</u>モデルに対応ていきます。

[u1]: ./1.html
[u2]: ./2.html
[u3]: ./3.html

---

<!--
https://www.datacamp.com/community/tutorials/r-formula-tutorial
-->
