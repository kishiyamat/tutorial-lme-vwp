---
layout: post
title: Rと統計の入門      
description: LMEの解説ページ 
---

<!-- [Home](./) -->

<!--
1. モデルとは?
1. 最終的に理解したい要素
1. 出てくるもののみに候補
-->
このチュートリアルには
統計パートと視線計測実験パートがあって、
統計パートのゴールは「一般化線形混合モデル」を用いた
統計分析ができるようになるというものです。
そのためには「モデル」とか「統計」とかを知らないといけません。
そこで導入として
<u>(i) どうしてモデルが必要なのか</u>という話と
<u>(ii) 統計パートで最終的に何を理解したいのか</u> を考えます。
そして最後に<u>(iii) 過程で必要なもの</u>を整理して
簡単なモデルを手を動かしながら作ってみる、という流れです。

ちなみに手を動かすのはこんな感じです。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
  </code>
  <code data-type="sample-code">
    # print 関数を使って
    # "Hello LME!" と出力してみてください
    # print("Hello LME!")
  </code>
  <code data-type="solution">
    print("Hello LME!")
  </code>
  <code data-type="sct">
    test_function("print")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  Use the assignment operator (<code><-</code> or <code>=</code> ) to create the variables.
  </div>
</div>

<!--
これは手を動かして見たほうが分かりやすかったりします。
でもそもそも「モデル」ってなんなんでしょうか。
まずはそこから考えてみましょう。
-->

## モデル: 現象を理解するための道具

<!--嬉しい理由-->
まず現象の理解が目的の研究を想定します。
例えば「主語述語の距離と認知的負荷の関係を知りたい」とか
「主語と述語の不一致が認知的負荷を生むんじゃなかろうか」
とか、そういうものです。
ここで認知的負荷というものが「単語の読み時間」という形で
観測できるなら、
(a) 読み時間を説明する要因は何か、また
(b) その要因はどの程度の大きいのか、
を知ることが現象の理解につながります。

上の例は少し偏ったものですが、
手持ちの課題を何か観測できる形に落とし込めたとします。
この作業を「Linking Hypothesis を置く」なんて言ったりしますが、
その観測と要因の関係を上の(a)と(b)で調べてあげたいわけです。
さて、その観測を説明しうる候補の要因が2つあるとして、
観測と要因1、要因2をそれぞれ $y$と$x_1$, $x_2$ としてあげましょう。

ちなみに斜体を使うとき、それは「中身の値は変わるかもよ」
という意味を込めています。なので変数とか言ったりしますが、
$y$には単語を読むのに何秒かかったかとか、
$x_1$ には主語と述語の間に何個単語があるかとか、
$x_2$ には主語と述部が一致してるかしてないかが0と1で表現されているとします。
でも、そのまま $y = x_1 + x_2$ とはなりませんよね。
そもそも $x_1$ と $x_2$ が両方読み時間を増やすとは限りませんし、
もしかしたら負の方向を取るかもしれません。

そこでそれぞれの値がどう $y$ の予測に効くのかを示す
$a_1$ と $a_2$ も考えてあげます。
例えば、 $x_1$ が全く効果がない場合は $a_1 = 0$ となりますね。
めちゃくちゃ効果ある場合は大きな値、
読み時間を減少させる場合は負の値になります。
掛け算を変数をくっつけて書くことで表現すると、
さっきの式は $y = a_1x_1 + a_2x_2 + b$ と書いたほうが良さそうです。
なお、切片である $b$ や $a$ は未知ですが $y$ や $x$ は既知ですね。

ここでもう一度 $y = a_1x_1 + a_2x_2 + b$ の式を見ると、
先ほどの問に答えられそうなことがわかります。
つまり、(i)読み時間を説明する要因は何か、
という問は傾き$a$が0でない要因はどれかを見ればいいですね。
また(ii)その要因はどの程度の大きさなのか、
という解いは傾き$a$ の大きさを見ればいいですね。
したがって、
<u>研究の目的が現象の理解である場合、
その目的は観測と要因を結ぶモデルの作成で達成できます</u>。

以上がモデルを学ぶ意義、つまり入り口になります。

## ノイズを無視したモデルが欲しい

<!--出口-->
出口はどこなのでしょうか。
それはシステマティックなノイズを考慮したモデルを作ることにあります。
例えば実験結果を分析してみようと思うと
すぐに直面する問題が個人差です。
実際に読み時間を考えても、
条件に反応しやすい人、しづらい人というのがあります。
そういう何かに条件付けられたシステマティックなノイズを「ランダム効果」として
切り捨てることで、本当に見たい効果が見れます。
<u>そんなモデルの一つが「一般化線形混合モデル」と呼ばれているもので、
このチュートリアルの最終到達目標になります</u>。

先ほどの $y = a_1x_1 + a_2x_2 + b$ がありましたが、
この $a$ や $b$ が $a = a_{true} + a_{subject_i}$ 
のようになっていると考えます。
つまり傾き$a$ は真の傾き$a_{true}$ に個人のノイズ $a_{subject_i}$ が
乗った(加算)されたものだよ、と表現してあげるわけです。
これをRというプログラミング言語で表現すると
(複雑さを避けるため、一旦要因が $x_1$ しかないケースを考える)、
`y ~ x_1 + (x_1 | subject)` のように表現します。
少し違和感があると思うので一つずつ解消していきましょう。

まず「あれ、$a$とか$b$とかどこいったの」となるかもしれません。
ただこれは単純な話で、$a$ の値がどうなっているのを知りたいということは
$a$ が未知なものということですよね。
Rではこういう未知なものを参照できないのです。
対照的に、`y`は観測した読み時間だし `x_1` はこちらが操作したであろう要因なので
既知ですよね。また、個人を示す `subject` も既知です。
したがって不明な$a$などのパラメータは記述せず、
既知なものだけでデータの関係を記述します。

つぎに「`(x_1 | subject)` って何」という話ですが、
個人`subject` ごとの`x_1` もモデルに組み込むことを示しています。
これにも対する傾きも推定することになりので、その傾きが先ほどの
$a = a_{true} + a_{subject_i}$ に出てきた $a_{subject_i}$ になります。
よく条件付けはバー、$|$で表しま すが、この条件付けられた `x_1` に対する傾きが
システマティックなノイズになります。
こういう奴もモデリングしてあげて、後で無視するわけです。
<!--
さっきとは式自体は違いますが結果は同じことを余裕があれば確認してください。
-->
なお「あれ$b$はどこ」という点については
デフォルトでRは式に`1`を追加していてくれるので、
それに対する傾きも未知となります。

先ほど「一般化線形混合モデル」は
システマティックなノイズを「ランダム効果」として
切り捨てて本当に見たい効果が見れる、という話をしました。
そしてこのランダム効果は `y ~ x_1 + (x_1 | subject)` という形で
表現できることも述べました。
Rではこのような`~`で結んだ式を `formula` と呼ぶのですが、
`model(formula, data)` と入力することで
未知な傾きなどを`model`が推定してくれます。
そして`model`には色々な種類があり
`lm`, `glm` そしてチュートリアルの最終到達目標の
`lmer` と抽象化されていきます。

したがって、私達がすることは以下になります。

1. `data` を用意: `y`や`x_1 `、`subject` などの観測した情報
2. `data` の関係を表現する `formula` を定義: `y ~ x_1 + (x_1 | subject)`
3. `model` に `formula` と `data` 与えて未知のパラメータを推定: 
   `lmer(y ~ x_1 + (x_1 | subject), data)`
4. fit したパラメータを見て分析

話が抽象的になって辛くなってきたので、
次に `data`, `formula`, `model` の実態を
手を動かしながら見ていきましょう[^code]。という
なお、以下の実習(ハンズオン)はスマホでもいけますが、
タイピングしやすい環境のほうが良いかもと思います。

[^code]:
    以前はゼミの勉強会などでは
    RとRStudioをインストールして、
    パッケージをインストールして、
    あぁバージョンが合わない、
    そもそも文字化けする、という悲しみがあったのですが、
    最近はウェブで実行できます。
    ありがとうインターネッツ。

## 道中に必要な data, formula, model
<!--
https://www.datacamp.com/community/tutorials/r-formula-tutorial
-->

上で `data`, `formula`, `model` とありましたが、
まずは `data` から問題を解きながら理解を深めていきます。
この `data` というのは Excel を思い浮かべると分かりやすいはずです。
時たま変な使い方しているケースもありますが、
基本的には一行目には列名で二行目からは各列のデータを持ちますよね。
それを R ではデータフレーム(data frame) と呼びます。

Rのデータフレームは`head()`や`summary()`
で中身を確認できます。
`sleepstudy` というデータを既に読み込んであるので、
`head()` や `summary()` の `()` に入れて動作を確認してみましょう。
`head` という機能は受け取ったデータの最初の6件をデフォルトで返し、
`summary` は受け取ったデータの要約をしてくれます。
<!--
これ良くないよなぁ.
lexdec だけ落とせない？
-->

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
    library(lme4)
  </code>
  <code data-type="sample-code">
    # lme4パッケージは読み込み済み
    # sleepstudy というデータが手元にある状態
    # それぞれの()に sleepstudy と入れて動作を確認
    head()
    summary()
  </code>
  <code data-type="solution">
    head(sleepstudy)
    summary(sleepstudy)  # 同上
  </code>
  <code data-type="sct">
    test_function("head")
    test_function("summary")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  Use the assignment operator (<code><-</code> or <code>=</code> ) to create the variables.
  </div>
</div>

ちゃんと `head` と `summary` の役割とデータフレームの概念を掴めたでしょうか。
どうしても実体が気になるひとは R Console の方に
`sleepstudy` とだけ打ち込んでみてください。
データを全件表示してくれます。
これはデータが少ないことを知っている時以外は行わないでください。
別に強制終了すれば良いのですがRが瀕死になります。
そうしたくなくて、ほんの頭の方数行でいいからを見せて、という
のが `head` です。

さて、データを得たら図示もしてみましょう。
その前に formula の復習です。
`sleapstudy` が持っている列名は
`Reaction` と `Days`, `Subject` の3つです。
ここで `Reaction` を `Days` 、ただし `Subject` で条件付けて
モデリングしてあげましょう。
どのような formula になるでしょうか。
答えを `f=` に書くと `f` に格納できます。
`print` で確認しましょう。

[^eq]: Rのコーディング規約的には `<-` が好ましいですが、
    そういうのは `styler` で一発で終わるので問題ありません。
    クラスを定義するときには違いがでてきますが、
    そういうのを気にする必要はまだありませんよね。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
  </code>
  <code data-type="sample-code">
    f = 
    print(f)
  </code>
  <code data-type="solution">
    f = Reaction ~ Days | Subject
    print(f)
  </code>
  <code data-type="sct">
    test_object("f")
    test_function("print")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  条件付けは | で行います。
  </div>
</div>

上手くできましたか。
このような `formula` は描画にも役立ちます。
描画には後々 `ggplot` というリッチなツールを使う事にもなるでしょうが、
今は分かりやすい `xyplot` という関数を使ってみましょう。
`xyplot` は `formula` と `data` を受け取って描画します。
カンマで区切って`formula`と`sleepstudy`渡してあげましょう。
かなり小さくなりますが、`Plots` タブをクリックすると
ポップアップして見れます。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
    library(lattice)  # for xyplot
    library(lme4)  # for sleapstudy data
  </code>
  <code data-type="sample-code">
    f = Reaction ~ Days | Subject
    xyplot() # edit here
  </code>
  <code data-type="solution">
    f = Reaction ~ Days | Subject
    xyplot(f, sleepstudy)
  </code>
  <code data-type="sct">
    test_function("xyplot")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  条件付けは | で行います。
  </div>
</div>

なお、Rは大文字と小文字を区別します。
こういうのを case sensitive と言いますが、
上のところで `Error: object 'days' not found`
みたいに怒られた人は
ちゃんと `formula` 内の単語が `sleepstudy` 
にあるものを書けているか確認しましょう。

さて、`data` と `formula` にもなれたでしょうか。
じつはこれで残るはあとひとつ、
`model` のみです。
線形回帰の `lm` を見てみましょう。
先ほどの `xyplot`同様、formulaとdataを受け取ります。


<!--
多分関数の話はいらない
-->

うえでの掛け算や足し算は複数の値にまとめて適用できます。
例えば、Rでは1から10の整数を `1:10` と表現できます。
このような複数の値のことを atomic vector と呼ぶのですが、
これを大文字の`X`に入れてみて、
先ほどと同様に `a*X + b` を計算して見ましょう。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
      a <- 2
      b <- 4
  </code>
  <code data-type="sample-code">
      # X = 1:10 で atomic vector を X に与えましょう。
      # a と b は定義してあるので、
      # Y = a*X + b で一次式の結果を計算できます。
      # print(Y) としてみましょう。
  </code>
  <code data-type="solution">
      # Create a variable a, equal to 5
      X <- 1:10
      # Print out a
      Y = a*X + b
      print(Y)
  </code>
  <code data-type="sct">
      test_object("X")
      test_object("Y")
      test_function("print")
      success_msg("Great job!")
  </code>
  <div data-type="hint">Use the assignment operator (<code><-</code> or <code>=</code> ) to create the variables.
  </div>
</div>

ちゃんと1から10の整数に2をかけて4を足した値が戻ってきましたね。
数字が出てきてもわかりづらいので、
`plot` という関数を使って`X`と`Y`の関係を図示してみましょう。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
      a <- 2
      b <- 4
      X <- 1:10
      Y = a*X + b
  </code>
  <code data-type="sample-code">
      # aを1と定義するときは a=1 とします。
      # plot(X, Y) でxとyの値を与えて図示できます。
  </code>
  <code data-type="solution">
      # Create a variable a, equal to 5
      plot(X, Y)
  </code>
  <code data-type="sct">
      plot(X, Y)
  </code>
  <div data-type="hint">Use the assignment operator (<code><-</code> or <code>=</code> ) to create the variables.
  </div>
</div>

さて、ここまでのところで「定義」や「変数」といった概念や、
値には一つのものや複数のものがあることがわかったと思います。
ただ現実の問題で $y=ax+b$ はわかりません。
そもそもyを説明するxがわかりませんし、
xがどのくらい大切なのかもわからないのです。

この 1. どの要因が 2. どの程度役に立つのか
を定量的に教えてくれるのがモデルになります。


<!--
https://r4ds.had.co.nz/model-basics.html#model-basics
-->

次にRの特徴である formula という概念に移ります。

先ほどは $y=ax+b$ を再現するため、まずは aを2, xを3, bを4と「定義」して
掛け算足し算をしましたが、
実はRだと `y ~ x` だけで表現できます。
そんな formula の表現は `f = y ~ x` と`f`に定義できます。

さっきの `X` と `y` は

統計を学ぶ意義と「モデル」について学ぶには
手を動かすのが一番の近道です。

<!--相関と因果関係について-->
<!--
-->

<!--
-->

現象の構成要素と各要素の重要さを検証する


実験や仮説検定という文脈を置くと、実験デザインは
実験をしてから統計をかけようとすると苦しいことになるのはなんででしょう。
交絡


AならばBの図式を取る。
AでないならばBでない
* 「私はこう思う」より多少マシで再現性を担保しやすくなる
* いわゆる「有意差」を見ればいいと勘違いしはじめる


この資料は視線計測実験のチュートリアルの前座で、
実験の後に通常かける分析についてのチュートリアルです。
ならなんで実験前にチュートリアルをやるのかというと、
実験を行う手順は 1. 使う統計モデルを決める 2. 実験する 3. 統計的仮説検定にかける
だからです。
つまり、統計をきめるというからには 1. 統計的仮説検定とはなにか、2. 統計モデルの種類
を知らないとならないわけです。

ただ、統計とはなんですか、一般化線形モデルとはなんですか、
という初歩から説明する事はありません。
そこは教科書に任せます。
このチュートリアルでやるのはその一歩先の
一般化線形混合モデルです。
基本的には統計の基礎、線形モデル、一般化線形モデルは教科書、
一般化線形混合モデルは新規の資料を作成、という形にします。

そもそも「仮説ってなんですか」という話ですが、
これは「結果Yに対して要因Aは影響する」のような命題のことです。
結果の例には 1. 読み時間とか 2. リスニングの正解率とか 3. 特定の画像への注視時間などの
数値にできるような値があります。
その結果(あるいはその結果が反映していると仮定されているなにか)に
影響する要因を知り尽くすことが目的な場合、
「結果Yに対して要因Aは影響する」という仮説を検証していかなければなりません。

また「うーん実験っていっても人を対象にするような内容じゃないしなぁ」
と思われる方もいるかも知れませんが、ここでいう「実験」はあくまでも表現であって、
もしかするとすでに手元にあるデータを何らかの仮説を持って検証することもあるかもしれません。
そういうのも実験と言って良いのではないかと思います。
要は人を対象とした実験に限った内容ではなく、
とにかくデータがあって統計モデルを使って仮説を検証する流れができるようになればいいです。

ここまででは仮説と実験の話しかしてませんが、
以下に 1. 統計的仮説検定とはなにか、2. 統計モデルの種類
についての概要とこのチュートリアルの構成を書いていきます。


ここまででは仮説と実験の話しかしてませんが、
まだ 1. 統計的仮説検定とはなにか、2. 統計モデルの種類
についての概要とこのチュートリアルの構成を書いていきます。
向けに統計を使った議論の仕方を共有することを

* 誰向けか
* 何をするか
* いつするか

心理言語学のデータ分析で使う一般化線形混合モデルまでのマイルストーン

* 統計的仮説検定の基本
* 線形モデルと一般化線形モデル
* 一般化線形混合モデル 

----------------

