---
layout: post
title: Rと統計の入門      
description: LMEの解説ページ 
---

<!-- [Home](./) -->

<!--
1. モデルとは?
1. 最終的に理解したい要素
1. 出てくるもののみに候補
-->
v.0.1

統計パートのゴールは「一般化線形混合モデル」を用いた統計分析の理解です。
そのためには「モデル」や「統計」の理解が必要です。
そこで導入として
<u>(i) モデルが必要な理由(why)</u>と
<u>(ii) 最終的に理解したい対象(what)</u> を考え、
<u>(iii) 過程で必要な概念(how)</u>を整理していきます。

なお、このチュートリアルのコンセプトは「モデルを手を動かしながら作ってみる」
ですが、下のような作業場を使っていきます。
(アドブロックをオンにしてるとセッションが壊れるそうです。
検証してくれたOさんに感謝します。)

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
  </code>
  <code data-type="sample-code">
    # print 関数を使って
    # "Hello LME!" と出力してみてください
    # print("Hello LME!")
  </code>
  <code data-type="solution">
    print("Hello LME!")
  </code>
  <code data-type="sct">
    test_function("print")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  Use the assignment operator (<code><-</code> or <code>=</code> ) to create the variables.
  </div>
</div>

<!--
これは手を動かして見たほうが分かりやすかったりします。
でもそもそも「モデル」ってなんなんでしょうか。
まずはそこから考えてみましょう。
-->

## モデル: 現象を理解するためのツール

<!--嬉しい理由-->
まず現象の理解が目的の研究を想定します。
例えば「主語述語の距離と認知的負荷の関係を知りたい」や
「主語と述語の不一致が認知的負荷を生むんじゃなかろうか」などです。
ここで認知的負荷を「単語の読み時間」で観測できるなら、
(1a) 読み時間を説明する要因 と (1b) 要因の大きさ
を知ることが現象の理解につながります。

上は偏った例ですが、同様に手持ちの課題を観測できる値に落とし込めたとします[^wh]。
画面の注視時間でもアンケートの値でもなんでもOKで、
その観測と要因の関係を上の(a)と(b)で調べてあげたいわけです。
<!--
さて、その観測に影響する候補の要因が2つあるとして、
観測を$y$, 要因1を$x_1$, 要因2を$x_2$ としてあげましょう。
-->
そこで$y$には単語の読み時間(s)、$x_1$ には主語--述語間の単語数、
$x_2$ には主語--述部の一致るかが0/1で表現されているとします。
ただ「単語数+1」としても$y$にはならないことから、
そのまま $y = x_1 + x_2$ とはならなさそうです。

[^wh]: この直接観測できない対象を観測できる値で代用する作業を
    「Linking Hypothesis を置く」なんて言ったりします。

<!--
ちなみに $\uparrow$ のように斜体を使うとき、
「中身の値は変わるかもよ」という意味を込めています。
なので変数とか言ったりしますが、-->
<!-- (そもそも $x_1$ と $x_2$ が両方読み時間を増やすとは限りません) -->

そこで各値と$y$の関係を調整してくれる $a_1$ や $a_2$ も考えてあげます。
例えば、$x_1$ が読み時間に影響しない場合は $a_1 = 0$ 、
大きく効果がある場合は大きな値、減少させる場合は負の値になります。 <!--
掛け算を変数をくっつけて書くことで表現すると、
--> するとさっきの式は $y = a_1x_1 + a_2x_2 + b$ と書いたほうが良さそうです。
(なお傾き$a$や切片$b$は未知ですが $y$ や $x$ は既知です。)

ここでもう一度 $y = a_1x_1 + a_2x_2 + b$ の式を見ると、
先ほどの問に答えられそうなことがわかります。
つまり (1a) 読み時間を説明する要因 は傾き$a$が0でない要因であり、
また (1b) 要因の大きさ は傾き$a$ の大きさですね。
したがって、<u>研究の目的が現象の理解である場合、
その目的は観測と要因を結ぶモデルの作成で達成できます</u>。

ただ(1a)で「この要因の傾きは0じゃないよ」と主張するには
どうしたら良いのでしょうか。
傾きが0.0001ならなくて10000ならあるのでしょうか。
実は傾きの値だけではわからず、
実際には傾きの「確からしさ」つまり
統計と確率が必要になります。

以上がモデルと統計を学ぶ意義になります。

## 一般化とノイズ

最終的に理解したい対象は
(2a) 直線以外の関係 と
(2b) 構造的なノイズ
を扱えるモデルの作成です。
それぞれの意義をいかに考えてみます。

まず(2a)に関して、
先ほどの例で読み時間を $y = a_1x_1 + a_2x_2 + b$ と表現することは、
読み時間が要因に対して直線の関係にあることや負の値を取れることを仮定してます。
しかし実際に読み時間が負の値を取ることはありません。
他にもアンケート(0--5など)、文の容認性(0--1)、OTのランキング(0--N)などで
マイナスの値を含めた範囲外の値を取れてしまいます。
そこで $y = a_1x_1 + a_2x_2 + b$ のような直線のモデルを
直線以外も扱えるよう一般化したのが「<u>一般化</u>線形モデル」です。

次に(2b)に関して、
読み時間などの実験結果を分析する際にすぐに直面する問題の個人差を考えましょう。
読み時間では条件に反応しやすい人、しづらい人はいます。
この個人差のような、
何かに条件付けられた構造的なノイズを「ランダム効果」として
切り捨てることで、本当に見たい効果が見れます。
先ほどの「一般化線形モデル」で更にこのランダム効果を考慮できるのが
「一般化線形<u>混合</u>モデル」です。
このチュートリアルの最終到達目標になります。

冒頭でこのチュートリアルのゴールは
一般化線形混合モデルを用いた統計分析の理解だと述べました。
この「一般化線形混合モデルを用いた統計分析」の意味はもう分かると思います。
つまり、$y = a_1x_1 + a_2x_2 + b$ のような線形モデルを
(2a) 直線以外の関係 に一般化させ
(2b) 構造的なノイズ を考慮した分析を行い、
(1a) 要因の有無の統計的な検証 と
(1b) 要因の大きさ
を検証するのです。
そうすれば様々な現象の理解を構造的なノイズを排除して理解でき、
研究の目的を達成する一助となります。

次に実際に手を動かしながら
最初のステップである
(1) 線形モデルの作成と
(2) 統計分析
を進めて行きましょう。
その過程で必要な概念を整理していきます。

## モデルの基本要素

モデルの作成と分析には
(i) `dataframe`
(ii) `formula`
(iii) `model`
の概念が必要です。

まず簡単な例として sleep study というデータを見てみましょう。
このデータを見るといったときの「データ」は
`dataframe` という概念を意味しているんだな、
と以降は読み替えてください。


`y ~ x_1` と表現します。
Rではこのような`~`で結んだ式を `formula` と呼ぶのですが、
`model(formula, data)` と入力することで
未知な傾きなどを`model`が推定してくれます。
そして`model`には色々な種類があり
`lm`, `glm` そしてチュートリアルの最終到達目標の
`lmer` と抽象化されていきます。

したがって、私達がすることは以下になります。

1. `data` を用意: `y`や`x_1 `、`subject` などの観測した情報
2. `data` の関係を表現する `formula` を定義: `y ~ x_1 + (x_1 | subject)`
3. `model` に `formula` と `data` 与えて未知のパラメータを推定: 
   `lmer(y ~ x_1 + (x_1 | subject), data)`
4. fit したパラメータを見て分析

話が抽象的になって辛くなってきたので、
次に `data`, `formula`, `model` の実態を
手を動かしながら見ていきましょう[^code]。という
なお、以下の実習(ハンズオン)はスマホでもいけますが、
タイピングしやすい環境のほうが良いかもと思います。

[^code]: 以前はゼミの勉強会などでは
    RとRStudioをインストールして、
    パッケージをインストールして、
    あぁバージョンが合わない、
    そもそも文字化けする、という悲しみがあったのですが、
    最近はウェブで実行できます。

<!--
https://www.datacamp.com/community/tutorials/r-formula-tutorial
-->

上で `data`, `formula`, `model` とありましたが、
まずは `data` から問題を解きながら理解を深めていきます。
この `data` というのは Excel を思い浮かべると分かりやすいはずです。
時たま変な使い方しているケースもありますが、
基本的には一行目には列名で二行目からは各列のデータを持ちますよね。
それを R ではデータフレーム(data frame) と呼びます。

Rのデータフレームは`head()`や`summary()`
で中身を確認できます。
`sleepstudy` というデータを既に読み込んであるので、
`head()` や `summary()` の `()` に入れて動作を確認してみましょう。
`head` という機能は受け取ったデータの最初の6件をデフォルトで返し、
`summary` は受け取ったデータの要約をしてくれます。
<!--
これ良くないよなぁ.
lexdec だけ落とせない？
-->

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
    library(lme4)
  </code>
  <code data-type="sample-code">
    # lme4パッケージは読み込み済み
    # sleepstudy というデータが手元にある状態
    # それぞれの()に sleepstudy と入れて動作を確認
    head()
    summary()
  </code>
  <code data-type="solution">
    head(sleepstudy)
    summary(sleepstudy)  # 同上
  </code>
  <code data-type="sct">
    test_function("head")
    test_function("summary")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  Use the assignment operator (<code><-</code> or <code>=</code> ) to create the variables.
  </div>
</div>

ちゃんと `head` と `summary` の役割とデータフレームの概念を掴めたでしょうか。
どうしても実体が気になるひとは R Console の方に
`sleepstudy` とだけ打ち込んでみてください。
データを全件表示してくれます。
これはデータが少ないことを知っている時以外は行わないでください。
別に強制終了すれば良いのですがRが瀕死になります。
そうしたくなくて、ほんの頭の方数行でいいからを見せて、という
のが `head` です。

さて、データを得たら図示もしてみましょう。
その前に formula の復習です。
`sleapstudy` が持っている列名は
`Reaction` と `Days`, `Subject` の3つです。
ここで `Reaction` を `Days` 、ただし `Subject` で条件付けて
モデリングしてあげましょう。
どのような formula になるでしょうか。
答えを `f=` に書くと `f` に格納できます。
`print` で確認しましょう。

[^eq]: Rのコーディング規約的には `<-` が好ましいですが、
    そういうのは `styler` で一発で終わるので問題ありません。
    クラスを定義するときには違いがでてきますが、
    そういうのを気にする必要はまだありませんよね。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
  </code>
  <code data-type="sample-code">
    f = 
    print(f)
  </code>
  <code data-type="solution">
    f = Reaction ~ Days | Subject
    print(f)
  </code>
  <code data-type="sct">
    test_object("f")
    test_function("print")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  条件付けは | で行います。
  </div>
</div>

上手くできましたか。
このような `formula` は描画にも役立ちます。
描画には後々 `ggplot` というリッチなツールを使う事にもなるでしょうが、
今は分かりやすい `xyplot` という関数を使ってみましょう。
`xyplot` は `formula` と `data` を受け取って描画します。
カンマで区切って`formula`と`sleepstudy`渡してあげましょう。
かなり小さくなりますが、`Plots` タブをクリックすると
ポップアップして見れます。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
    library(lattice)  # for xyplot
    library(lme4)  # for sleapstudy data
  </code>
  <code data-type="sample-code">
    f = Reaction ~ Days | Subject
    xyplot() # edit here
  </code>
  <code data-type="solution">
    f = Reaction ~ Days | Subject
    xyplot(f, sleepstudy)
  </code>
  <code data-type="sct">
    test_function("xyplot")
    success_msg("Great job!")
  </code>
  <div data-type="hint">
  条件付けは | で行います。
  </div>
</div>

なお、Rは大文字と小文字を区別します。
こういうのを case sensitive と言いますが、
上のところで `Error: object 'days' not found`
みたいに怒られた人は
ちゃんと `formula` 内の単語が `sleepstudy` 
にあるものを書けているか確認しましょう。

さて、`data` と `formula` にもなれたでしょうか。
じつはこれで残るはあとひとつ、
`model` のみです。
線形回帰の `lm` を見てみましょう。
先ほどの `xyplot`同様、formulaとdataを受け取ります。


<!--
多分関数の話はいらない
-->

うえでの掛け算や足し算は複数の値にまとめて適用できます。
例えば、Rでは1から10の整数を `1:10` と表現できます。
このような複数の値のことを atomic vector と呼ぶのですが、
これを大文字の`X`に入れてみて、
先ほどと同様に `a*X + b` を計算して見ましょう。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
      a <- 2
      b <- 4
  </code>
  <code data-type="sample-code">
      # X = 1:10 で atomic vector を X に与えましょう。
      # a と b は定義してあるので、
      # Y = a*X + b で一次式の結果を計算できます。
      # print(Y) としてみましょう。
  </code>
  <code data-type="solution">
      # Create a variable a, equal to 5
      X <- 1:10
      # Print out a
      Y = a*X + b
      print(Y)
  </code>
  <code data-type="sct">
      test_object("X")
      test_object("Y")
      test_function("print")
      success_msg("Great job!")
  </code>
  <div data-type="hint">Use the assignment operator (<code><-</code> or <code>=</code> ) to create the variables.
  </div>
</div>

ちゃんと1から10の整数に2をかけて4を足した値が戻ってきましたね。
数字が出てきてもわかりづらいので、
`plot` という関数を使って`X`と`Y`の関係を図示してみましょう。

<div data-datacamp-exercise data-lang="r">
  <code data-type="pre-exercise-code">
      a <- 2
      b <- 4
      X <- 1:10
      Y = a*X + b
  </code>
  <code data-type="sample-code">
      # aを1と定義するときは a=1 とします。
      # plot(X, Y) でxとyの値を与えて図示できます。
  </code>
  <code data-type="solution">
      # Create a variable a, equal to 5
      plot(X, Y)
  </code>
  <code data-type="sct">
      plot(X, Y)
  </code>
  <div data-type="hint">Use the assignment operator (<code><-</code> or <code>=</code> ) to create the variables.
  </div>
</div>

さて、ここまでのところで「定義」や「変数」といった概念や、
値には一つのものや複数のものがあることがわかったと思います。
ただ現実の問題で $y=ax+b$ はわかりません。
そもそもyを説明するxがわかりませんし、
xがどのくらい大切なのかもわからないのです。

この 1. どの要因が 2. どの程度役に立つのか
を定量的に教えてくれるのがモデルになります。


<!--
https://r4ds.had.co.nz/model-basics.html#model-basics
-->

次にRの特徴である formula という概念に移ります。

先ほどは $y=ax+b$ を再現するため、まずは aを2, xを3, bを4と「定義」して
掛け算足し算をしましたが、
実はRだと `y ~ x` だけで表現できます。
そんな formula の表現は `f = y ~ x` と`f`に定義できます。

さっきの `X` と `y` は

統計を学ぶ意義と「モデル」について学ぶには
手を動かすのが一番の近道です。

<!--相関と因果関係について-->
<!--
-->

<!--
-->

現象の構成要素と各要素の重要さを検証する


実験や仮説検定という文脈を置くと、実験デザインは
実験をしてから統計をかけようとすると苦しいことになるのはなんででしょう。
交絡


AならばBの図式を取る。
AでないならばBでない
* 「私はこう思う」より多少マシで再現性を担保しやすくなる
* いわゆる「有意差」を見ればいいと勘違いしはじめる


この資料は視線計測実験のチュートリアルの前座で、
実験の後に通常かける分析についてのチュートリアルです。
ならなんで実験前にチュートリアルをやるのかというと、
実験を行う手順は 1. 使う統計モデルを決める 2. 実験する 3. 統計的仮説検定にかける
だからです。
つまり、統計をきめるというからには 1. 統計的仮説検定とはなにか、2. 統計モデルの種類
を知らないとならないわけです。

ただ、統計とはなんですか、一般化線形モデルとはなんですか、
という初歩から説明する事はありません。
そこは教科書に任せます。
このチュートリアルでやるのはその一歩先の
一般化線形混合モデルです。
基本的には統計の基礎、線形モデル、一般化線形モデルは教科書、
一般化線形混合モデルは新規の資料を作成、という形にします。

そもそも「仮説ってなんですか」という話ですが、
これは「結果Yに対して要因Aは影響する」のような命題のことです。
結果の例には 1. 読み時間とか 2. リスニングの正解率とか 3. 特定の画像への注視時間などの
数値にできるような値があります。
その結果(あるいはその結果が反映していると仮定されているなにか)に
影響する要因を知り尽くすことが目的な場合、
「結果Yに対して要因Aは影響する」という仮説を検証していかなければなりません。

また「うーん実験っていっても人を対象にするような内容じゃないしなぁ」
と思われる方もいるかも知れませんが、ここでいう「実験」はあくまでも表現であって、
もしかするとすでに手元にあるデータを何らかの仮説を持って検証することもあるかもしれません。
そういうのも実験と言って良いのではないかと思います。
要は人を対象とした実験に限った内容ではなく、
とにかくデータがあって統計モデルを使って仮説を検証する流れができるようになればいいです。

ここまででは仮説と実験の話しかしてませんが、
以下に 1. 統計的仮説検定とはなにか、2. 統計モデルの種類
についての概要とこのチュートリアルの構成を書いていきます。


ここまででは仮説と実験の話しかしてませんが、
まだ 1. 統計的仮説検定とはなにか、2. 統計モデルの種類
についての概要とこのチュートリアルの構成を書いていきます。
向けに統計を使った議論の仕方を共有することを

* 誰向けか
* 何をするか
* いつするか

心理言語学のデータ分析で使う一般化線形混合モデルまでのマイルストーン

* 統計的仮説検定の基本
* 線形モデルと一般化線形モデル
* 一般化線形混合モデル 

----------------

